<!doctype HTML>
<html>
  <head>
    <title>Salary of Every BART Employee</title>
    <script src="js/d3.js" charset="utf-8"></script>
    <script src="js/fisheye.js"></script>
    <script src="js/jquery.js"></script>
    <style>
      body{ margin: 0; font-family: helvetica; }
      button, select { outline: none;}
      .node { fill: black; }
      #controls{ position: absolute; bottom: 10px; right: 10px; text-align: right;}
      #source{
        position: absolute;
        left: 10px;
        bottom: 10px;
      }
      #title{
        width: 100%;
        position: absolute;
      }
      #title h1{
        text-align: center;
        margin: 10px;
      }
      circle { stroke: none; }
      .node.active circle {
        stroke-width: 1;
        stroke: white;
      }
      .node.highlighted circle { 
        stroke: black;
        stroke-width: 15;
        stroke-opacity: 0.5;
      }
      .tooltip{ display: none; }
      .tooltip .bg{ opacity: 0.7; }
      .tooltip text{
        fill: white;
      }
      active.tooltip{
        display: inherit;
      }
      .node text{
        text-anchor: middle;
        fill: black;
      }
      .sort-by.active, .sort-by:active{
        border: 1px solid #000;
        background-color: #333;
        color: white;
      }
      .sort-by{
        border: 1px solid #999;
      }
      .share-left{ margin-top: 20px; position: absolute; left: 10px;}
      .share-right{ margin-top: 20px; position: absolute; right: 10px;}
    </style>
  </head>
  <body>
    <div id="title">
      <div class="share-left">
        <a href="https://twitter.com/vicapow" class="twitter-follow-button" data-show-count="false">Follow @vicapow</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      </div>
      <div class="share-right">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="vicapow" data-hashtags="hackthebart">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      </div>
      <h1>Salary of Every BART Employee</h1>
    </div>
    <div id="controls">
      <p>color by: 
        <select class="color">
          <option value="Union"> Union </option>
          <option value="Title"> Title </option>
        </select>
        sort by: 
        <button class="sort-by active" data-metric="TCOE">Total cost of employee</button>
        <button class="sort-by" data-metric="Base">base</button>
        <button class="sort-by" data-metric="OT">overtime</button>
        <button class="sort-by" data-metric="OT to Base">overtime to base</button>
        <button class="sort-by" data-metric="MDV">medical, dental, vision</button>
        <button class="sort-by" data-metric="ER">employer contributions to pension</button>
        <button class="sort-by" data-metric="DC">401(k)</button>
        <button class="sort-by" data-metric="Misc">Miscellaneous</button>
        <button class="sort-by" data-metric="Other">other</button>
        <button class="sort-by" data-metric="Title">title</button>
        <button class="sort-by" data-metric="Union">union</button>
      </p>
    </div>
    <div id="source"> 
      source: <a href="https://github.com/enjalot/bart#data-links"> Employee Salaries </a>
    </div>
    <script>
      var width = window.innerWidth, height = window.innerHeight
        , vis = d3.select('body').append('svg').attr('class', 'vis')
          .style({ width: width + 'px', height: height + 'px' })
        , node, max, margin = 30, max_area = 300, tooltip, margin_top = 70, margin_bottom = 100
        , color = d3.scale.category20()
        , ident = function(d){ return d }
        , radiusScale = d3.scale.linear().range([0, max_area])
        , areaToRadius = function(area){ return Math.sqrt(area / Math.PI) }
        , fisheye = d3.fisheye.circular().radius(30).distortion(2)
        , colorMetric = 'Union'
        , radius = function(d){ 
          var metric = sortMetric
          if(metric === 'Title' || metric === 'Union') metric = 'TCOE'
          return areaToRadius(radiusScale(d[metric])) 
        }
        , x = d3.scale.linear().domain([0, 100]).range([margin, width - margin])
        , y = d3.scale.linear().domain([0, 28]).range([margin_top, height - margin_bottom])
        , dataKey = function(d){ return d.id }
        , sortBy = function(by){ return function(a, b){ 
            if(a[by] === b[by]) return 0; else if(a[by] > b[by]) return -1;
            return 1;
        }}, money = d3.format('$,04d')
        , id = 0, order = 0
        , format = function(d){
            // Name,Title,Base,OT,Other,MDV,ER,EE,DC,Misc,TCOE,,Average,
            var numKeys = ['Base', 'OT', 'Other', 'MDV', 'ER', 'EE', 'DC', 'Misc', 'TCOE'];
            numKeys.forEach(function(key){ d[key] = Number(d[key]) })
            d.id = id++
            d.order = order++
            d['OT to Base'] = d.OT / d.Base
            return d
        }, topNode = null

      d3.csv('bart-comp-all.csv', format, function(err, rows){
        if(err) throw err
        employees = rows
        gotEmployees(employees)
        fisheyeEffect(vis)
      })
      function updateRadiusScale(sortMetric){
        var metric = sortMetric
        if(metric === 'Title' || metric === 'Union') metric = 'TCOE'
        radiusScale.domain([0, d3.max(employees, function(d){ return d[metric] })])
      }
      function gotEmployees(employees){
        updateRadiusScale('TCOE')
        node = vis.selectAll('.node').data(employees, dataKey)
          .enter().append('g')
            .attr('class', 'node')
            .call(updateColor)
        node.append('circle').attr('r', radius)
        node.call(randomize).call(updatePos).call(sortNodesByMetric.bind(null, 'TCOE'))
        node.on('click', function(){
          var node // = d3.select('.node.highlighted').classed('highlighted', false).node()
            , sel = d3.select(this)
          if(sel.node() !== node) sel.classed('highlighted', !d3.select(this).classed('highlighted'))
        })
        vis.call(createTooltip)
      }
      function createTooltip(vis){
        tooltip = vis.append('g').attr('class', 'tooltip')
        tooltip.append('rect').attr({ width: 130, height: 140, rx: 5, ry: 5, class: 'bg' })
        var desc = tooltip.append('g').attr('class', 'desc')
        desc.append('text').attr('class', 'name').text('name: ').attr('transform', 'translate(5,15)')
        desc.append('text').attr('class', 'title').text('title: ').attr('transform', 'translate(5,35)')
        desc.append('text').attr('class','union').text('union: ').attr('transform', 'translate(5,55)')
        desc.append('text').attr('class','main').text('total: ').attr('transform', 'translate(5,75)')
        return tooltip
      }
      function posTooltip(node){
        if(node.empty()) return
        var d = node.datum(), text, x = d.fisheye.x, y = d.fisheye.y
        if(sortMetric === 'OT to Base') text = sortMetric + ': ' 
          + d3.round(d[sortMetric], 2) + ' ' + 'OT: ' + money(d.OT) 
          + ' Base:' + money(d.Base)
        else if(sortMetric === 'Title' || sortMetric === 'Union') text = d.Title
        else text = sortMetric + ': ' + money(d[sortMetric])
        if(text === d.Title || text === d.Union) text = 'Base: ' + money(d.Base) + ' OT: ' + money(d.OT) + ''
        tooltip.select('.main').text(text)
        tooltip.select('.title').text(d.Title)
        tooltip.select('.name').text(d.Name)
        tooltip.select('.union').text('Union: ' + d.Union)
        var box = tooltip.select('.desc').node().getBBox()
        box.x -= 10, box.y -= 10, box.width += 20, box.height += 20
        tooltip.select('rect').attr(box)
        var offset = radius(d) * d.fisheye.z
        if( x > width / 2 ) x -= box.width + offset; else x+= offset
        if( y > height / 2 ) y -= box.height + offset; else y+= offset
        tooltip.attr('transform', 'translate(' + x + ',' + y + ')')
      }
      function updatePos(node){
        node.attr('transform', function(d){
          return 'translate(' + d.x + ',' + d.y + ')'
        })
        updateRadiusScale(sortMetric)
        node.select('circle').attr('r', radius)
        return node
      }
      function updateColor(node){
        node.style('fill', function(d){ return color(d[colorMetric]) })
      }
      function setFisheyePos(node){
        node.attr('transform', function(d, i){
          return 'translate(' + d.fisheye.x + ', ' + d.fisheye.y + ')'
        })
        node.select('circle').attr('transform', function(d){
          var z = d.fisheye && d.fisheye.z || 1
          return 'scale(' + z + ')'
        })
        return node
      }
      function randomize(node){
        node.each(function(d){
          d.x = Math.random() * width
          d.y = Math.random() * height
        })
      }
      function grid(node){
        return node.data().forEach(function(d){
          d.x = x(d.order % x.domain()[1])
          d.y = y(Math.floor(d.order / x.domain()[1]))
        })
      }
      function sortNodesByMetric(metric, node){
        var data = node.data().sort(sortBy(metric))
        data.forEach(function(d, i){ d.order = i })
        node.data(data, dataKey)
        return node.call(grid).transition().duration(2000).call(updatePos)
      }
      function sortByTitle(node){
        var nest = d3.nest()
          .key(function(d){ return d.Title })
          .sortKeys(d3.ascending)
          .sortValues(d3.ascending)
          .key(function(d){ return d.TCOE })
          .entries(node.data())
        var data = []
        nest.forEach(function(leaf){
          leaf.values.forEach(function(leaf){ data = data.concat(leaf.values) })
        })
        data.forEach(function(d, i){ d.order = i })
        return node.data(data, dataKey).call(grid)
          .transition().duration(2000).call(updatePos)
      }
      function sortByUnion(node){
        var nest = d3.nest()
          .key(function(d){ return d.Union })
          .sortKeys(d3.ascending)
          .sortValues(d3.ascending)
          .key(function(d){ return d.TCOE })
          .entries(node.data())
        var data = []
        nest.forEach(function(leaf){
          leaf.values.forEach(function(leaf){ data = data.concat(leaf.values) })
        })
        data.forEach(function(d, i){ d.order = i })
        return node.data(data, dataKey).call(grid)
          .transition().duration(2000).call(updatePos)
      }
      // listen for sort button clicks
      var sortMetric = 'TCOE'
      $('.sort-by').on('click', function(){
        var newMetric = $(this).data('metric')
        if(sortMetric === newMetric) return
        sortMetric = newMetric
        if(sortMetric === 'Title') sortByTitle(node)
        else if(sortMetric === 'Union') sortByUnion(node)
        else sortNodesByMetric(sortMetric, node)
        $('.sort-by.active').removeClass('active')
        $(this).addClass('active')
      })
      $('.color').on('change', function(){
        var newMetric = $(this).val()
        console.log("newMetric", newMetric)
        if(newMetric === colorMetric) return
        colorMetric = newMetric
        node.transition().duration(2000).call(updateColor)
      })
      $(window).resize(function(){
        width = window.innerWidth
        height = window.innerHeight
        vis.style({ width: width + 'px', height: height + 'px' })
        x.range([margin, width - margin])
        y.range([margin_top, height - margin_bottom])
        node.call(grid).call(updatePos)
      })
      function fisheyeEffect(vis){
        return vis.on('mouseover', function(d){
          if(!node) return
          d3.select('.tooltip').style('display', 'inherit')
          //node.each(function(d, i){  $(this).removeClass('animated') })
        }).on("mousemove", function(d){
          var m = d3.mouse(this)
          fisheye.focus(m)
          if(!node) return
          node.each(function(d, i){
            var prev_z = d.fisheye && d.fisheye.z || 1
            d.fisheye = fisheye(d)
            d.fisheye.prev_z = prev_z
          })
          .filter(function(d){ return d.fisheye.z !== d.fisheye.prev_z })
          .sort(function(a, b){ return a.fisheye.z > b.fisheye.z ? 1 : -1 })
          .call(setFisheyePos)
          .call(function(node){
            var max, maxNode
            node.each(function(d){
              if( !max || d.fisheye.z > max.fisheye.z) { max = d; maxNode = this }
            })
            if(topNode !== maxNode) updateTopNode(maxNode)
          })
        }).on('mouseleave', function(d){
          d3.select('.tooltip').style('display', 'none')
          node.each(function(d, i){ d.fisheye = {x: d.x, y: d.y, z: 1} })
          .filter(function(d){ return d.fisheye.z !== d.fisheye.prev_z })
          .call(setFisheyePos)
        })
      }

      function updateTopNode(maxNode){
        if(topNode) topNode.classed('active', false)
        topNode = d3.select(maxNode).classed('active', true)
        topNode.call(posTooltip)
      }
    </script>
<!-- google analytics -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-39250901-2']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
  </body>
</html>